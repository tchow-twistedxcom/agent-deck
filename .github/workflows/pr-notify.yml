name: PR Notification

on:
  pull_request_target:
    types: [opened, ready_for_review]

jobs:
  notify:
    runs-on: ubuntu-latest
    # Skip draft PRs unless they become ready
    if: github.event.pull_request.draft == false
    steps:
      - name: Gather PR context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Get PR files changed
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            // Get PR commits
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 50
            });

            // Get PR reviews (if any)
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // Get PR comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              per_page: 20
            });

            // Get review comments (inline comments on code)
            const reviewComments = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 50
            });

            // Search for related issues/PRs
            const searchQuery = `repo:${context.repo.owner}/${context.repo.repo} ${pr.title.split(' ').slice(0, 3).join(' ')}`;
            const related = await github.rest.search.issuesAndPullRequests({
              q: searchQuery,
              per_page: 5
            });

            // Build context object
            const prContext = {
              type: 'pull_request',
              number: pr.number,
              title: pr.title,
              body: pr.body || '',
              author: pr.user.login,
              url: pr.html_url,
              state: pr.state,
              draft: pr.draft,
              mergeable: pr.mergeable,
              base_branch: pr.base.ref,
              head_branch: pr.head.ref,
              created_at: pr.created_at,
              updated_at: pr.updated_at,
              additions: pr.additions,
              deletions: pr.deletions,
              changed_files_count: pr.changed_files,
              labels: pr.labels.map(l => l.name),

              // Files changed with patches (truncated for large diffs)
              files: files.data.map(f => ({
                filename: f.filename,
                status: f.status,  // added, removed, modified, renamed
                additions: f.additions,
                deletions: f.deletions,
                patch: f.patch ? f.patch.substring(0, 2000) : null  // Truncate large patches
              })),

              // Commits in this PR
              commits: commits.data.map(c => ({
                sha: c.sha.substring(0, 7),
                message: c.commit.message.split('\n')[0],
                author: c.commit.author.name
              })),

              // Reviews
              reviews: reviews.data.map(r => ({
                author: r.user.login,
                state: r.state,  // APPROVED, CHANGES_REQUESTED, COMMENTED
                body: r.body
              })),

              // PR comments
              comments: comments.data.map(c => ({
                author: c.user.login,
                body: c.body
              })),

              // Inline review comments
              review_comments: reviewComments.data.slice(0, 20).map(c => ({
                author: c.user.login,
                path: c.path,
                line: c.line,
                body: c.body
              })),

              // Related issues/PRs
              related: related.data.items
                .filter(i => i.number !== pr.number)
                .slice(0, 5)
                .map(i => ({
                  number: i.number,
                  title: i.title,
                  state: i.state,
                  is_pr: !!i.pull_request
                }))
            };

            // Determine PR type from title/labels
            const labels = pr.labels.map(l => l.name.toLowerCase());
            const titleLower = pr.title.toLowerCase();

            let prType = 'unknown';
            if (labels.includes('bug') || titleLower.includes('fix') || titleLower.includes('bug')) {
              prType = 'bugfix';
            } else if (labels.includes('feature') || titleLower.includes('feat') || titleLower.includes('add')) {
              prType = 'feature';
            } else if (labels.includes('docs') || titleLower.includes('doc')) {
              prType = 'docs';
            } else if (titleLower.includes('refactor')) {
              prType = 'refactor';
            } else if (titleLower.includes('test')) {
              prType = 'test';
            } else if (titleLower.includes('chore') || titleLower.includes('ci')) {
              prType = 'chore';
            }

            prContext.detected_type = prType;

            // Return as base64
            return Buffer.from(JSON.stringify(prContext)).toString('base64');

      - name: Send to ntfy
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          PR_CONTEXT_B64: ${{ steps.context.outputs.result }}
        run: |
          # Strip quotes and decode (safe - no untrusted input in shell directly)
          PR_CONTEXT=$(echo "$PR_CONTEXT_B64" | tr -d '"' | base64 -d)

          # Parse using jq (safe extraction from JSON)
          PR_NUM=$(echo "$PR_CONTEXT" | jq -r '.number')
          PR_TITLE=$(echo "$PR_CONTEXT" | jq -r '.title')
          PR_TYPE=$(echo "$PR_CONTEXT" | jq -r '.detected_type')

          # Send to ntfy
          curl -s \
            -H "Title: PR #${PR_NUM} - ${PR_TITLE}" \
            -H "Priority: high" \
            -H "Tags: github,pr,${PR_TYPE}" \
            -d "$PR_CONTEXT" \
            "https://ntfy.sh/${NTFY_TOPIC}"
