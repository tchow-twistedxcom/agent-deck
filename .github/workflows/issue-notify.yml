name: Issue Notification

on:
  issues:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Gather issue context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Get issue comments (if any exist already)
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              per_page: 10
            });

            // Search for related issues
            const searchQuery = `repo:${context.repo.owner}/${context.repo.repo} is:issue ${issue.title.split(' ').slice(0, 3).join(' ')}`;
            const related = await github.rest.search.issuesAndPullRequests({
              q: searchQuery,
              per_page: 5
            });

            // Get recent commits for context
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });

            // Build context object
            const issueContext = {
              number: issue.number,
              title: issue.title,
              body: issue.body || '',
              labels: issue.labels.map(l => l.name),
              author: issue.user.login,
              url: issue.html_url,
              created_at: issue.created_at,
              comments: comments.data.map(c => ({
                author: c.user.login,
                body: c.body
              })),
              related_issues: related.data.items
                .filter(i => i.number !== issue.number)
                .slice(0, 5)
                .map(i => ({
                  number: i.number,
                  title: i.title,
                  state: i.state,
                  labels: i.labels.map(l => l.name)
                })),
              recent_commits: commits.data.slice(0, 5).map(c => ({
                sha: c.sha.substring(0, 7),
                message: c.commit.message.split('\n')[0]
              }))
            };

            // Determine issue type
            const labels = issue.labels.map(l => l.name.toLowerCase());
            const titleLower = issue.title.toLowerCase();
            const bodyLower = (issue.body || '').toLowerCase();

            let issueType = 'unknown';
            if (labels.includes('bug') || titleLower.includes('bug') || titleLower.includes('fix') || bodyLower.includes('error') || bodyLower.includes('crash')) {
              issueType = 'bug';
            } else if (labels.includes('enhancement') || labels.includes('feature') || titleLower.includes('feature') || titleLower.includes('add')) {
              issueType = 'feature';
            } else if (labels.includes('documentation') || labels.includes('docs')) {
              issueType = 'docs';
            } else if (labels.includes('question') || titleLower.includes('how') || titleLower.includes('?')) {
              issueType = 'support';
            }

            issueContext.detected_type = issueType;

            // Return as base64 to avoid shell escaping issues
            return Buffer.from(JSON.stringify(issueContext)).toString('base64');

      - name: Send to ntfy
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          ISSUE_CONTEXT_B64: ${{ steps.context.outputs.result }}
        run: |
          # Strip quotes from JSON-encoded output, then decode base64
          ISSUE_CONTEXT=$(echo "$ISSUE_CONTEXT_B64" | tr -d '"' | base64 -d)

          # Parse for notification title
          ISSUE_NUM=$(echo "$ISSUE_CONTEXT" | jq -r '.number')
          ISSUE_TITLE=$(echo "$ISSUE_CONTEXT" | jq -r '.title')
          ISSUE_TYPE=$(echo "$ISSUE_CONTEXT" | jq -r '.detected_type')

          # Send to ntfy with full context in body
          curl -s \
            -H "Title: #${ISSUE_NUM} - ${ISSUE_TITLE}" \
            -H "Priority: high" \
            -H "Tags: github,issue,${ISSUE_TYPE}" \
            -d "$ISSUE_CONTEXT" \
            "https://ntfy.sh/${NTFY_TOPIC}"
